class o{constructor(){this.searchInput=document.querySelector("[data-search-input]"),this.categoryButtons=document.querySelectorAll('[data-filter-action="category"]'),this.postsGrid=document.querySelector(".posts-grid, .cases-grid"),this.searchTimeout=null,this.searchDelay=500,this.state={search:"",categoryIds:[],categorySlugs:[],postType:this.getPostType(),taxonomy:this.getTaxonomy(),page:1},this.initFromUrl(),(this.searchInput||this.categoryButtons.length>0)&&this.init()}init(){this.searchInput&&this.searchInput.addEventListener("input",t=>{this.handleSearchInput(t.target.value)}),this.categoryButtons.length>0&&this.categoryButtons.forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),this.handleCategoryClick(e.currentTarget)})}),window.addEventListener("popstate",()=>{this.initFromUrl(),this.performFilter()}),this.postsGrid&&this.postsGrid.classList.add("filterable-grid"),document.addEventListener("click",t=>{const e=t.target.closest('nav[aria-label="Pagination"] a');e&&(t.preventDefault(),this.handlePaginationClick(e))})}initFromUrl(){const t=new URLSearchParams(window.location.search);this.state.search=t.get("s")||"";const e=t.get("category")||"";this.searchInput&&this.state.search&&(this.searchInput.value=this.state.search),e&&(e.split(",").filter(a=>a.trim()!=="").forEach(a=>{const i=document.querySelector(`[data-category-slug="${a.trim()}"]`);if(i){const r=i.dataset.categoryId||"";this.state.categoryIds.includes(r)||(this.state.categoryIds.push(r),this.state.categorySlugs.push(a.trim()))}}),this.updateActiveCategoryButtons())}handleSearchInput(t){this.searchTimeout&&clearTimeout(this.searchTimeout),this.state.search=t,this.state.page=1,this.setLoadingState(!0),this.searchTimeout=setTimeout(()=>{this.performFilter()},this.searchDelay)}handleCategoryClick(t){const e=t.dataset.categoryId||"",s=t.dataset.categorySlug||"";if(e===""&&s==="")this.state.categoryIds=[],this.state.categorySlugs=[];else{const a=this.state.categoryIds.indexOf(e);a>-1?(this.state.categoryIds.splice(a,1),this.state.categorySlugs.splice(a,1)):(this.state.categoryIds.push(e),this.state.categorySlugs.push(s))}this.state.page=1,this.updateActiveCategoryButtons(),this.setLoadingState(!0,"grid"),this.performFilter()}handlePaginationClick(t){const e=new URL(t.href),s=e.searchParams.get("paged")||e.pathname.match(/\/page\/(\d+)/),a=s?Array.isArray(s)?parseInt(s[1]):parseInt(s):1;this.state.page=a,this.setLoadingState(!0,"grid"),this.performFilter()}updateActiveCategoryButtons(){if(this.categoryButtons.forEach(t=>{t.classList.remove("badge-active"),t.classList.add("badge-outline")}),this.state.categoryIds.length===0){const t=document.querySelector('[data-category-id=""]');t&&(t.classList.add("badge-active"),t.classList.remove("badge-outline"))}else this.state.categoryIds.forEach(t=>{const e=document.querySelector(`[data-category-id="${t}"]`);e&&(e.classList.add("badge-active"),e.classList.remove("badge-outline"))})}async performFilter(){try{console.log("Performing filter:",this.state);const t=new FormData;t.append("action","archive_filter_search"),t.append("nonce",window.sageData.nonce),t.append("search",this.state.search),t.append("post_type",this.state.postType),t.append("category_ids",JSON.stringify(this.state.categoryIds)),t.append("paged",this.state.page),this.state.taxonomy&&t.append("taxonomy",this.state.taxonomy);const e=await fetch(window.sageData.ajaxUrl,{method:"POST",body:t});if(!e.ok)throw new Error("Network response was not ok");const s=await e.json();console.log("Filter response:",s),s.success?(this.updateGrid(s.data.html),this.updateUrl()):(console.error("Filter failed:",s.data),this.showError(s.data.message||"Filtering failed. Please try again."))}catch(t){console.error("Filter error:",t),this.showError("An error occurred. Please try again.")}finally{this.setLoadingState(!1,"search"),this.setLoadingState(!1,"grid")}}updateGrid(t){console.log("Updating grid with new content"),this.postsGrid?(this.postsGrid.style.opacity="0.5",this.postsGrid.style.transition="opacity 150ms ease-in-out",setTimeout(()=>{this.postsGrid.innerHTML=t,this.postsGrid.style.opacity="1",console.log("Grid updated successfully"),this.postsGrid.scrollIntoView({behavior:"smooth",block:"start"})},150)):console.error("Posts/Cases grid element not found!")}updateUrl(){const t=new URL(window.location);this.state.search&&this.state.search.trim()!==""?t.searchParams.set("s",this.state.search):t.searchParams.delete("s"),this.state.categorySlugs.length>0?t.searchParams.set("category",this.state.categorySlugs.join(",")):t.searchParams.delete("category"),window.history.pushState({},"",t)}setLoadingState(t,e="search"){if(e==="search"||e==="all"){const s=document.querySelector(".search-icon"),a=document.querySelector(".search-loading");t?(s&&s.classList.add("hidden"),a&&a.classList.remove("hidden"),this.searchInput&&this.searchInput.classList.add("opacity-50")):(s&&s.classList.remove("hidden"),a&&a.classList.add("hidden"),this.searchInput&&this.searchInput.classList.remove("opacity-50"))}(e==="grid"||e==="all")&&this.postsGrid&&(t?this.postsGrid.classList.add("filtering"):this.postsGrid.classList.remove("filtering"))}showError(t){console.error(t)}getPostType(){const t=document.body.className;return t.includes("post-type-archive-case")||t.includes("tax-case_category")?"case":"post"}getTaxonomy(){const t=document.body.className;return t.includes("tax-case_category")?"case_category":t.includes("category")?"category":null}}document.addEventListener("DOMContentLoaded",()=>{new o});
